<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sweet Trip Planner</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #fff; color: #000; transition: background 0.3s, color 0.3s; }
    .dark-mode { background: #121212; color: #fff; }
    header, footer { padding: 1rem; text-align: center; background: #6200ee; color: #fff; }
    main { padding: 1rem; max-width: 800px; margin: auto; }
    label, input, select { display: block; margin: 0.5rem 0; }
    #map { height: 300px; margin: 1rem 0; }
    .sweet-row { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; }
    .progress-container { background: #ccc; height: 20px; width: 100%; margin: 1rem 0; }
    .progress-bar { height: 100%; width: 0%; background: green; }
    .sweet-list { margin-top: 1rem; }
    button { margin-top: 1rem; }
  </style>
</head>
<body>
  <header>
    <h1>Sweet Trip Planner üç¨</h1>
    <button onclick="toggleDarkMode()">Toggle Dark Mode</button>
  </header>

  <main>
    <form id="tripForm">
      <label for="start">Start Location:</label>
      <input id="start" name="start" type="text" required />

      <label for="end">End Location:</label>
      <input id="end" name="end" type="text" required />

      <label for="mode">Travel Mode:</label>
      <select id="mode">
        <option value="driving-car">Driving</option>
        <option value="foot-walking">Walking</option>
        <option value="cycling-regular">Cycling</option>
      </select>

      <div id="sweetInputs">
        <div class="sweet-row">
          <input type="text" placeholder="Sweet Type" class="sweet-type" />
          <input type="number" placeholder="Quantity" class="sweet-qty" min="1" />
          <button type="button" onclick="removeSweetRow(this)">‚àí</button>
        </div>
      </div>
      <button type="button" onclick="addSweetRow()">+ Add Sweet</button>

      <button type="submit">Plan My Trip</button>
    </form>

    <div id="map"></div>
    <div class="progress-container">
      <div class="progress-bar" id="progressBar"></div>
    </div>
    <div id="countdownText"></div>
    <button onclick="window.print()">Print Trip</button>
  </main>

  <footer>
    &copy; 2025 Sweet Trip Planner
  </footer>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    let map = L.map('map').setView([55.8642, -4.2518], 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    let routeLine;

    const API_KEY = 'eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6ImZmNTMyZTAyM2FmMjQxYzJiM2UzYTUzMjgzZWU5NjAxIiwiaCI6Im11cm11cjY0In0=';

    function toggleDarkMode() {
      document.body.classList.toggle("dark-mode");
    }

    function addSweetRow() {
      const container = document.getElementById("sweetInputs");
      const div = document.createElement("div");
      div.className = "sweet-row";
      div.innerHTML = `
        <input type="text" placeholder="Sweet Type" class="sweet-type" />
        <input type="number" placeholder="Quantity" class="sweet-qty" min="1" />
        <button type="button" onclick="removeSweetRow(this)">‚àí</button>
      `;
      container.appendChild(div);
    }

    function removeSweetRow(button) {
      button.parentElement.remove();
    }

    async function getCoords(location) {
      const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(location)}`);
      const data = await res.json();
      if (data.length === 0) throw new Error("Location not found");
      return [parseFloat(data[0].lon), parseFloat(data[0].lat)];
    }

    async function getRoute(startCoords, endCoords, mode) {
      const res = await fetch(`https://api.openrouteservice.org/v2/directions/${mode}/geojson`, {
        method: 'POST',
        headers: {
          'Authorization': API_KEY,
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          coordinates: [startCoords, endCoords]
        }),
      });
      const data = await res.json();
      return data;
    }

    function showProgress(durationMinutes, sweetEvents) {
      const progress = document.getElementById("progressBar");
      const text = document.getElementById("countdownText");
      let startTime = Date.now();
      let totalTime = durationMinutes * 60 * 1000;
      let sweetIndex = 0;

      function update() {
        let elapsed = Date.now() - startTime;
        let pct = Math.min(elapsed / totalTime, 1);
        progress.style.width = (pct * 100) + "%";

        let nextSweetTime = sweetEvents[sweetIndex];
        if (elapsed >= nextSweetTime) {
          alert("Time for a sweet! üç≠");
          sweetIndex++;
        }

        if (pct < 1) {
          text.textContent = `Time remaining: ${Math.ceil((totalTime - elapsed) / 60000)} mins`;
          requestAnimationFrame(update);
        } else {
          text.textContent = "You've arrived!";
        }
      }

      update();
    }

    document.getElementById("tripForm").addEventListener("submit", async function (e) {
      e.preventDefault();
      const start = document.getElementById("start").value;
      const end = document.getElementById("end").value;
      const mode = document.getElementById("mode").value;

      const sweetTypes = Array.from(document.getElementsByClassName("sweet-type")).map(i => i.value).filter(v => v);
      const sweetQtys = Array.from(document.getElementsByClassName("sweet-qty")).map(i => parseInt(i.value)).filter(v => v > 0);
      const totalSweets = sweetQtys.reduce((a, b) => a + b, 0);

      try {
        const startCoords = await getCoords(start);
        const endCoords = await getCoords(end);
        const data = await getRoute(startCoords, endCoords, mode);
        const duration = data.features[0].properties.summary.duration / 60;

        if (routeLine) map.removeLayer(routeLine);
        routeLine = L.geoJSON(data).addTo(map);
        map.fitBounds(routeLine.getBounds());

        const interval = duration * 60 * 1000 / totalSweets;
        const sweetSchedule = Array.from({ length: totalSweets }, (_, i) => (i + 1) * interval);
        showProgress(duration, sweetSchedule);

      } catch (err) {
        alert("Error: " + err.message);
      }
    });
  </script>
</body>
</html>
